{% extends "base.html" %}
{% block title %}GestiÃ³n de Archivos{% endblock %}
{% block content %}

<style>
    body { font-family: Arial, sans-serif; }

    /* MenÃº principal */
    .main-menu ul { list-style: none; padding: 0; }
    .main-menu li { padding: 10px 15px; cursor: pointer; background: #eee; margin-bottom: 5px; border-radius: 4px; }
    .main-menu li.active { background: #ccc; font-weight: bold; }

    /* SubmenÃºs */
    .submenu { list-style: none; padding-left: 20px; display: none; }
    .submenu li { background: #ddd; margin-bottom: 3px; padding: 8px 12px; cursor: pointer; border-radius: 4px; }
    .submenu li.active { background: #bbb; font-weight: bold; }

    /* Contenido */
    .menu-content { display: none; margin-top: 20px; }
    .tab-content { display: none; margin-top: 15px; }

    /* Barra de progreso */
    #progress-container { display:none; margin-top:10px; }
    #progress-bar { width:0%; height:20px; background:#4caf50; border-radius:5px; }

    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    form { padding: 15px; border-radius: 5px; transition: background 0.3s ease; }
</style>

<h2>Bienvenido {{ username }} (Rol: {{ role }})</h2>

<!-- MenÃº -->
<div class="main-menu">
    <ul>
        <li class="menu-item active" data-target="subir">ðŸ“‚ Subir Archivos
            <ul class="submenu">
                <li class="submenu-item active" data-target="trabajadores">ðŸ‘· Trabajadores</li>
                <li class="submenu-item" data-target="actividades">ðŸ“‹ Actividades</li>
            </ul>
        </li>
        <li class="menu-item" data-target="agregar">âž• Agregar Planilla</li>
    </ul>
</div>

<!-- Contenido Subir Archivos -->
<div id="subir" class="menu-content" style="display:block;">

    <!-- Subir trabajadores -->
    <div id="trabajadores" class="tab-content" style="display:block;">
        <h3>Subir Excel de Trabajadores</h3>
        <form id="uploadFormTrabajadores" enctype="multipart/form-data">
            <input type="file" name="file" required>
            <input type="hidden" name="tipo" value="trabajadores">
            <button type="submit" class="btn btn-primary">Cargar</button>
        </form>
    </div>

    <!-- Subir actividades -->
    <div id="actividades" class="tab-content">
        <h3>Subir Excel de Actividades</h3>
        <form id="uploadFormActividades" enctype="multipart/form-data">
            <input type="file" name="file" required>
            <input type="hidden" name="tipo" value="actividades">
            <button type="submit" class="btn btn-primary">Cargar</button>
        </form>
    </div>
</div>

<!-- Contenido Agregar Planilla -->
<div id="agregar" class="menu-content">
    <h3>Agregar Planilla</h3>
    <p>En desarrollo...</p>
</div>

<!-- Barra de progreso -->
<div id="progress-container">
    <div style="width:100%; background:#f1f1f1; border-radius:5px;">
        <div id="progress-bar"></div>
    </div>
    <span id="progress-text">0%</span>
</div>

<div id="upload-result"></div>

<!-- Tablas -->
<h3>Datos cargados</h3>

<div id="tabla-trabajadores">
    <h4>Trabajadores</h4>
    <table>
        <thead>
            <tr><th>ID</th><th>RUT</th><th>Nombre</th><th>Cargo</th></tr>
        </thead>
        <tbody>
        {% for t in trabajadores %}
            <tr><td>{{ t.id }}</td><td>{{ t.rut }}</td><td>{{ t.nombre }}</td><td>{{ t.cargo }}</td></tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<div id="tabla-actividades" style="margin-top:30px;">
    <h4>Actividades</h4>
    <table>
        <thead>
            <tr><th>ID</th><th>ID1</th><th>ID2</th><th>DescripciÃ³n</th><th>Rendimiento</th><th>PonderaciÃ³n</th><th>Unidad</th></tr>
        </thead>
        <tbody>
        {% for a in actividades %}
            <tr>
                <td>{{ a.id }}</td><td>{{ a.id_1 }}</td><td>{{ a.id_2 }}</td>
                <td>{{ a.descripcion }}</td><td>{{ a.rendimiento }}</td><td>{{ a.ponderacion }}</td><td>{{ a.unidad }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<script>
// --- MenÃº principal ---
const menuItems = document.querySelectorAll('.menu-item');
menuItems.forEach(item => {
    item.addEventListener('click', () => {
        document.querySelectorAll('.menu-content').forEach(mc => mc.style.display = 'none');
        menuItems.forEach(mi => mi.classList.remove('active'));

        item.classList.add('active');
        const target = item.dataset.target;
        document.getElementById(target).style.display = 'block';

        // Mostrar submenu solo si es "Subir Archivos"
        if (target === "subir") {
            item.querySelector('.submenu').style.display = 'block';
        } else {
            document.querySelectorAll('.submenu').forEach(sm => sm.style.display = 'none');
        }
    });
});

// --- SubmenÃºs ---
const submenuItems = document.querySelectorAll('.submenu-item');
submenuItems.forEach(sub => {
    sub.addEventListener('click', e => {
        submenuItems.forEach(s => s.classList.remove('active'));
        sub.classList.add('active');

        const target = sub.dataset.target;
        document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
        document.getElementById(target).style.display = 'block';

        e.stopPropagation();
    });
});

// --- Subida con progreso ---
function setupUpload(formId) {
    const form = document.getElementById(formId);
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const uploadResult = document.getElementById('upload-result');

    form.addEventListener('submit', function(e){
        e.preventDefault();
        const formData = new FormData(form);
        const xhr = new XMLHttpRequest();

        xhr.open('POST', '{{ url_for("upload_excel") }}', true);

        xhr.upload.onprogress = function(e){
            if(e.lengthComputable){
                const percent = Math.round((e.loaded / e.total) * 100);
                progressContainer.style.display = 'block';
                progressBar.style.width = percent + '%';
                progressText.textContent = percent + '%';
            }
        };

        xhr.onload = function(){
            if(xhr.status === 200){
                uploadResult.innerHTML = '<span style="color:green;">Archivo cargado correctamente!</span>';
                progressBar.style.width = '100%';
                progressText.textContent = '100%';
                setTimeout(()=> location.reload(), 1000);
            } else {
                uploadResult.innerHTML = '<span style="color:red;">Error al subir el archivo.</span>';
            }
        };

        xhr.send(formData);
    });
}

setupUpload('uploadFormTrabajadores');
setupUpload('uploadFormActividades');
</script>

{% endblock %}
